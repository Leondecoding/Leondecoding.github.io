---
layout: default
---

<div class="container product-page">
  <div class="product-grid" style="display:grid;grid-template-columns:minmax(260px,1fr) minmax(360px,1fr);gap:64px;align-items:start;padding-left:30px;">

    <!-- 左：主图（多字段兜底） -->
    <div class="product-gallery">
      {% assign candidates = '' | split: '' %}
      {% if page.image %}{% assign candidates = candidates | push: page.image %}{% endif %}
      {% if page.featured_image %}{% assign candidates = candidates | push: page.featured_image %}{% endif %}
      {% if page.cover %}{% assign candidates = candidates | push: page.cover %}{% endif %}
      {% if page.hero %}{% assign candidates = candidates | push: page.hero %}{% endif %}
      {% if page.thumbnail %}{% assign candidates = candidates | push: page.thumbnail %}{% endif %}
      {% if page.thumb %}{% assign candidates = candidates | push: page.thumb %}{% endif %}
      {% if page.picture %}{% assign candidates = candidates | push: page.picture %}{% endif %}
      {% if page.photo %}{% assign candidates = candidates | push: page.photo %}{% endif %}
      {% if page.images and page.images.size > 0 %}{% assign candidates = candidates | push: page.images[0] %}{% endif %}
      {% if page.photos and page.photos.size > 0 %}{% assign candidates = candidates | push: page.photos[0] %}{% endif %}

      {% assign title_dash = page.title | replace: ' ', '-' %}
      {% assign slug_dash  = page.title | slugify %}
      {% capture cand1 %}/assets/images/originals/{{ title_dash }}.jpg{% endcapture %}
      {% capture cand2 %}/assets/images/originals/{{ title_dash }}-1.jpg{% endcapture %}
      {% capture cand3 %}/assets/images/originals/{{ slug_dash }}.jpg{% endcapture %}
      {% capture cand4 %}/assets/images/originals/{{ slug_dash }}-1.jpg{% endcapture %}
      {% assign candidates = candidates | push: cand1 | push: cand2 | push: cand3 | push: cand4 %}

      {% assign main_image_url = nil %}
      {% for c in candidates %}
        {% if c %}
          {% assign p = c | strip %}
          {% if p != '' %}
            {% unless p contains '://' %}
              {% assign first_char = p | slice: 0, 1 %}
              {% if first_char != '/' %}{% assign p = '/' | append: p %}{% endif %}
            {% endunless %}
            {% assign main_image_url = p %}
            {% break %}
          {% endif %}
        {% endif %}
      {% endfor %}

      <img class="product-main-image" src="{{ main_image_url | relative_url }}" alt="{{ page.title | escape }}" style="max-width:100%;height:auto;display:block;"/>

      {% if page.images and page.images.size > 1 %}
        <div class="product-thumbs" style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;">
          {% for t in page.images %}
            {% if t %}
              {% assign tpath = t %}
              {% unless tpath contains '://' %}
                {% assign first_char = tpath | slice: 0, 1 %}
                {% if first_char != '/' %}{% assign tpath = '/' | append: tpath %}{% endif %}
              {% endunless %}
              <img class="product-thumb" src="{{ tpath | relative_url }}" alt="{{ page.title | escape }} thumbnail" style="width:72px;height:auto;border:1px solid #eee;padding:2px;"/>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <!-- 右：信息栏（标题 → 价格 → Taxes → 按钮 → 说明） -->
    <div class="product-info fz-product" style="margin-top:32px;">
      {% assign file_display = main_image_url | split: '/' | last %}
      {% if file_display == '' or file_display == nil %}{% assign file_display = page.title %}{% endif %}
      <h1 class="product-title" style="margin:0 0 8px 0;">{{ file_display }}</h1>

      {% assign price_raw = page.price | default: page.price_gbp | default: page.priceGBP | default: page.amount | default: page.cost | default: page.Price %}
      {% assign currency_code = page.currency | default: site.currency | default: 'GBP' %}
      {% assign curr = currency_code | upcase %}
      {% assign sym = '' %}
      {% if curr == 'GBP' %}{% assign sym = '£' %}{% elsif curr == 'USD' %}{% assign sym = '$' %}{% elsif curr == 'EUR' %}{% assign sym = '€' %}{% elsif curr == 'CNY' or curr == 'JPY' %}{% assign sym = '¥' %}{% elsif curr == 'HKD' %}{% assign sym = 'HK$' %}{% elsif curr == 'TWD' %}{% assign sym = 'NT$' %}{% endif %}

      {% if price_raw %}
        <div class="product-price" style="font-size:1.125rem;font-weight:600;margin:0 0 6px 0;float:none;clear:both;text-align:left;">
          {% if sym != '' %}{{ sym }}{{ price_raw }}{% else %}{{ price_raw }}{% if curr %} {{ curr }}{% endif %}{% endif %}
        </div>
      {% endif %}

      <div class="product-taxes" style="color:#555;margin:0 0 12px 0;float:none;clear:both;text-align:left;">Taxes included.</div>

      {% assign default_size = page.selected_size | default: page.size | default: 'A4' %}
      {% assign sku_base = page.sku | default: page.slug | default: page.title | slugify %}

      <div class="product-actions" style="display:flex;flex-direction:column;gap:8px;max-width:420px;float:none;clear:both;text-align:left;">
        <!-- PayPal（使用 data-* 承载参数；未配置账户时弹提示；配置后新开 PayPal 页） -->
        <a
          id="pp-buy"
          href="#"
          data-business="{{ site.paypal_business | default: '' }}"
          data-item-name="{{ page.title | default: file_display | escape }}"
          {% if price_raw %}data-amount="{{ price_raw }}"{% endif %}
          data-currency="{{ currency_code }}"
          data-os0="{{ default_size }}"
          style="display:inline-block;width:100%;padding:12px 16px;text-align:center;border:1px solid #ccc;border-radius:4px;"
        >Pay via PayPal</a>

        <!-- Add to Cart（严格对齐购物车数据；并提供兜底入栏） -->
        <form class="product-cart" onsubmit="return false;">
          <input type="radio" name="size" value="{{ default_size }}" checked hidden>
          <button
            type="button"
            id="btn-add-to-cart"
            class="js-add-to-cart"
            data-title="{{ page.title | default: file_display | escape }}"
            {% if price_raw %}data-price="{{ price_raw }}"{% endif %}
            data-currency="{{ currency_code }}"
            data-image="{{ main_image_url | relative_url }}"
            data-sku="{{ sku_base }}"
            data-option-input="size"
            data-option-name="Size"
            style="width:100%;padding:12px 16px;"
          >Add to Cart</button>
        </form>
      </div>

      <!-- 作品说明 -->
      <div class="product-description" style="margin-top:16px;max-width:65ch;">{{ content }}</div>
    </div>

  </div>
</div>

<!-- 本页兜底脚本：保证三图标可点、Add to Cart 入栏 + 角标更新、购物车抽屉可查看、PayPal 正常反馈 -->
<script>
(function(){
  function ready(fn){ if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',fn);} else {fn();} }

  // —— 工具
  function qs(sel,root){ return (root||document).querySelector(sel); }
  function qsa(sel,root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }
  function loadCart(){ try { return JSON.parse(localStorage.getItem('fz_cart')||'[]'); } catch(e){ return []; } }
  function saveCart(a){ localStorage.setItem('fz_cart', JSON.stringify(a)); }
  function updateBadge(){
    var b = qs('#fz-cart-count'); if(!b) return;
    var n = loadCart().reduce(function(m,i){ return m + (i.qty||1); }, 0);
    b.textContent = String(n); b.hidden = n<=0;
  }
  function getSelectedValue(btn){
    var n = btn.dataset.optionInput || 'size';
    var wrap = btn.closest('.fz-product') || document;
    var picked = qs('input[name="'+n+'"]:checked', wrap);
    return picked ? picked.value : '';
  }
  function formatCurrency(v, code){
    var sym = (code==='GBP')?'£':(code==='USD')?'$':(code==='EUR')?'€':((code==='JPY'||code==='CNY')?'¥':(code==='HKD')?'HK$':(code==='TWD')?'NT$':''));
    var n = parseFloat(v||'0'); return (sym||'') + (isFinite(n)? n.toFixed(2) : v);
  }

  // —— 渲染购物车抽屉
  function renderCartDrawer(){
    var box = qs('#fz-cart-content'); if(!box) return;
    var items = loadCart();
    if(!items.length){ box.innerHTML = '<p>当前为空。</p>'; return; }
    var total = 0;
    box.innerHTML = items.map(function(it){
      var p = parseFloat(it.price)||0, q = it.qty||1; total += p*q;
      var opt = (it.options && it.options[0]) ? ' <span style="color:#666;font-size:.9em;">('+it.options[0].name+': '+it.options[0].value+')</span>' : '';
      return '<div style="display:grid;grid-template-columns:64px 1fr auto;gap:12px;align-items:center;">'
        + (it.image?('<img src="'+it.image+'" alt="" style="width:64px;height:64px;object-fit:cover;border:1px solid #eee;">'):'<div style="width:64px;height:64px;background:#f4f4f4"></div>')
        + '<div><div style="font-weight:600;">'+it.title+'</div>'+opt+'</div>'
        + '<div style="font-weight:600;">'+formatCurrency(p,it.currency)+' × '+q+'</div>'
        + '</div>';
    }).join('') + '<hr style="margin:12px 0;"><div style="display:flex;justify-content:space-between;font-weight:700;">'
      + '<span>Total</span><span>'+formatCurrency(total,(items[0]&&items[0].currency)||'{{ currency_code | escape }}')+'</span></div>';
  }

  ready(function(){

    // 1) PayPal 立即购买（未配置则提示；配置则提交到 PayPal）
    (function(){
      var a = qs('#pp-buy'); if(!a) return;
      a.onclick = function(ev){
        ev.preventDefault();
        try{
          var biz = a.dataset.business || '';
          var item = a.dataset.itemName || document.title || 'Artwork';
          var amt  = a.dataset.amount || '';
          var cur  = a.dataset.currency || 'GBP';
          var os0  = a.dataset.os0 || '';
          if(!biz){
            alert('PayPal 尚未配置。请先加入购物篮，等账号就绪后统一结账。');
            return false;
          }
          var f = document.createElement('form');
          f.method = 'post';
          f.action = 'https://www.paypal.com/cgi-bin/webscr';
          f.target = '_blank';
          function add(n,v){ if(v==null||v==='')return; var i=document.createElement('input'); i.type='hidden'; i.name=n; i.value=String(v); f.appendChild(i); }
          add('cmd','_xclick'); add('business',biz); add('item_name',item); add('amount',amt); add('currency_code',cur); add('os0',os0);
          document.body.appendChild(f); f.submit(); f.remove();
          return false;
        }catch(e){ console.error(e); return false; }
      };
    })();

    // 2) Add to Cart（本页兜底；若全站脚本也绑定，不冲突）
    (function(){
      var btn = qs('#btn-add-to-cart'); if(!btn) return;
      btn.onclick = function(){
        try{
          var optionName  = btn.dataset.optionName || 'Size';
          var optionValue = getSelectedValue(btn);
          var item = {
            sku:   (btn.dataset.sku || 'item') + (optionValue?('-'+optionValue):''),
            title: (btn.dataset.title || 'Artwork') + (optionValue?(' - '+optionValue):''),
            price: parseFloat(btn.dataset.price || '0'),
            currency: btn.dataset.currency || 'GBP',
            image: btn.dataset.image || '',
            qty: 1,
            options: optionValue ? [{ name: optionName, value: optionValue }] : []
          };
          var cart = loadCart();
          var exist = cart.find(function(x){ return x.sku === item.sku; });
          if (exist) exist.qty = (exist.qty||1) + 1; else cart.push(item);
          saveCart(cart); updateBadge();

          // 轻提示
          var old = btn.textContent; btn.disabled = true; btn.textContent = 'Added ✓';
          setTimeout(function(){ btn.textContent = old; btn.disabled = false; }, 900);
        }catch(e){ console.error(e); }
      };
      updateBadge();
    })();

    // 3) 三个图标兜底交互（搜索 / 登录 / 购物篮）
    (function(){
      var sBtn=qs('#fz-search-btn'), lBtn=qs('#fz-login-btn'), cBtn=qs('#fz-cart-btn');
      if (sBtn) sBtn.addEventListener('click', function(){ var p=qs('#fz-search-panel'); if(p) p.hidden=false; });
      qsa('[data-close="fz-search-panel"]').forEach(function(el){ el.addEventListener('click', function(){ var p=qs('#fz-search-panel'); if(p) p.hidden=true; }); });

      if (lBtn) lBtn.addEventListener('click', function(e){ e.stopPropagation(); var m=qs('#fz-login-menu'); if(!m) return; var open=m.hidden; m.hidden=!open; lBtn.setAttribute('aria-expanded', String(open)); });
      document.addEventListener('click', function(e){ var m=qs('#fz-login-menu'); if(m && !m.hidden && !m.contains(e.target) && e.target!==lBtn){ m.hidden=true; lBtn && lBtn.setAttribute('aria-expanded','false'); } });

      if (cBtn) cBtn.addEventListener('click', function(){ renderCartDrawer(); var d=qs('#fz-cart-drawer'); if(d) d.hidden=false; });
      qsa('[data-close="fz-cart-drawer"]').forEach(function(el){ el.addEventListener('click', function(){ var d=qs('#fz-cart-drawer'); if(d) d.hidden=true; }); });
    })();

  });
})();
</script>
