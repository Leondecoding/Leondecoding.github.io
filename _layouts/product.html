---
layout: default
---

{{ content }}

<!--
  Leondecoding · product layout
  目的：仅为“Pay via PayPal”与“Add to Cart”提供可用的 PayPal 提交，不改动已有布局/文案/样式/顺序。
  行为：
    - 监听页面上文字精确为 “Pay via PayPal” 与 “Add to Cart” 的按钮/链接/提交控件。
    - 点击时在前端临时构建 <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_blank">，
      注入必需隐藏字段后提交到 PayPal 官方页面。
    - 价格与尺寸：继续复用现有 price_raw 与 default_size；如页面上已有 name="os0" 的可见/隐藏控件，将以其当前值为准。
    - 货币：默认 GBP，亦支持 page.currency / site.currency。
    - 不改任何可见 DOM、类名、顺序与按钮文案。
-->
<script>
(function () {
  // ---- 将 Jekyll 变量安全注入到 JS（使用 jsonify 以保证正确转义）----
  var PAYPAL_BUSINESS = {{ site.paypal_business | jsonify }};
  var ITEM_NAME       = {{ page.item_name | default: page.title | jsonify }};
  var AMOUNT_RAW      = {{ price_raw | jsonify }};
  var CURRENCY_CODE   = {{ page.currency | default: site.currency | default: 'GBP' | jsonify }};
  var DEFAULT_SIZE    = {{ default_size | jsonify }};

  // 若未配置收款邮箱，则保持静默（不破坏页面）
  if (!PAYPAL_BUSINESS || PAYPAL_BUSINESS === "null" || PAYPAL_BUSINESS === "") {
    console.warn("[product.html] site.paypal_business 未配置：PayPal 提交将被跳过。");
  }

  // 从页面上读取尺寸：优先取已有 name="os0" 的控件（select/radio/input），否则退回 default_size
  function readSizeFromPage() {
    var val = null;
    var sel = document.querySelector('select[name="os0"]');
    if (sel) return sel.value;

    var radios = document.querySelectorAll('input[type="radio"][name="os0"]');
    if (radios && radios.length) {
      for (var i = 0; i < radios.length; i++) if (radios[i].checked) return radios[i].value;
      // 无选中则取第一个值（若有）
      return radios[0].value;
    }

    var input = document.querySelector('input[name="os0"]');
    if (input) return input.value;

    return (DEFAULT_SIZE || "");
  }

  // 构建并提交表单到 PayPal 官方
  function submitToPayPal(fields) {
    if (!PAYPAL_BUSINESS || PAYPAL_BUSINESS === "null" || PAYPAL_BUSINESS === "") return;

    var form = document.createElement("form");
    form.method = "post";
    form.action = "https://www.paypal.com/cgi-bin/webscr";
    form.target = "_blank";

    function add(name, value) {
      if (value === undefined || value === null || value === "") return;
      var input = document.createElement("input");
      input.type = "hidden";
      input.name = name;
      input.value = String(value);
      form.appendChild(input);
    }

    // 通用字段
    add("business", PAYPAL_BUSINESS);
    add("item_name", ITEM_NAME);
    add("amount", AMOUNT_RAW);
    add("currency_code", CURRENCY_CODE);

    // 具体流程字段
    Object.keys(fields).forEach(function (k) { add(k, fields[k]); });

    document.body.appendChild(form);
    form.submit();
    form.remove();
  }

  // 点击处理：buy = 立即购买（_xclick）；cart = 加入购物车（_cart + add=1）
  function handle(type) {
    var size = readSizeFromPage();

    if (type === "buy") {
      // 立即购买：只按要求携带 os0（尺寸），其他最小字段集
      submitToPayPal({
        cmd: "_xclick",
        os0: size
      });
    } else if (type === "cart") {
      // 购物车：按要求携带 on0/os0（尺寸）
      submitToPayPal({
        cmd: "_cart",
        add: "1",
        on0: "Size",
        os0: size
      });
    }
  }

  // 根据按钮可见文字绑定事件（不改按钮/样式/顺序）
  function textOf(el) {
    // 按钮用 textContent，input[submit] 用 value
    return (el.tagName === "INPUT") ? (el.value || "") : (el.textContent || "");
  }
  function wire(el, type) {
    // 点击按钮 => 阻止原本站内提交，转而提交到 PayPal
    el.addEventListener("click", function (ev) {
      if (!PAYPAL_BUSINESS) return; // 未配置则放行，避免影响其它逻辑
      ev.preventDefault();
      ev.stopPropagation();
      handle(type);
    }, { passive: false });

    // 若按钮在 <form> 内，防止原 form 提交到本站
    var parentForm = el.closest("form");
    if (parentForm) {
      parentForm.addEventListener("submit", function (ev) {
        if (!PAYPAL_BUSINESS) return;
        var submitterText = (document.activeElement && textOf(document.activeElement).trim()) || "";
        // 仅当通过这两个按钮触发时拦截
        if (submitterText === "Pay via PayPal") {
          ev.preventDefault(); ev.stopImmediatePropagation(); handle("buy");
        } else if (submitterText === "Add to Cart") {
          ev.preventDefault(); ev.stopImmediatePropagation(); handle("cart");
        }
      }, { passive: false });
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    // 找到所有候选控件（按钮/链接/提交控件），按可见文字精确匹配
    var candidates = document.querySelectorAll('button, a, input[type="button"], input[type="submit"]');
    candidates.forEach(function (el) {
      var txt = textOf(el).trim();
      if (txt === "Pay via PayPal") {
        wire(el, "buy");
      } else if (txt === "Add to Cart") {
        wire(el, "cart");
      }
    });
  });
})();
</script>
